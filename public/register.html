<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Reader</title>
</head>

<body>
    <a href="/">Check in user</a>
    <h1>Register new guest</h1>
    <p>Scan a band to allocate</p>
    <div id="uid">No UID detected</div>

    <h2>Register User</h2>
    <form id="user-form">
        <label for="first_name">First Name:</label>
        <input type="text" id="first_name" name="first_name" required><br>

        <label for="last_name">Last Name:</label>
        <input type="text" id="last_name" name="last_name" required><br>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required><br>

        <label for="phone">Phone:</label>
        <input type="tel" id="phone" name="phone" required><br>

        <label for="tag_number">Tag Number:</label>
        <input type="text" id="tag_number" name="tag_number" required><br>

        <button type="submit">Register</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        socket.on('uid', uid => {
            document.getElementById('uid').textContent = uid;
            document.getElementById('tag_number').value = uid;
        });

        // Handle form submission
        document.getElementById('user-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const firstName = document.getElementById('first_name').value;
            const lastName = document.getElementById('last_name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const tagNumber = document.getElementById('tag_number').value;

            try {
                // Insert user data
                const userResponse = await fetch('https://pwqgcrolbarwoilssltg.supabase.co/rest/v1/users', {
                    method: 'POST',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3cWdjcm9sYmFyd29pbHNzbHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTgzNzA2NDgsImV4cCI6MjAzMzk0NjY0OH0.xIKlqvnIaZ6OvnZy8s8m_6A_azmo0POOq_ELGyO7GyE',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3cWdjcm9sYmFyd29pbHNzbHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTgzNzA2NDgsImV4cCI6MjAzMzk0NjY0OH0.xIKlqvnIaZ6OvnZy8s8m_6A_azmo0POOq_ELGyO7GyE',
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'  // To get the user ID back
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        email: email,
                        phone: phone
                    })
                });

                if (!userResponse.ok) throw new Error('Failed to register user.');

                const user = await userResponse.json();
                console.log('User details:', user);  // Logging user details

                const userId = user[0].user_id;  // Assuming user response directly returns user ID

                // Insert RFID tag data
                const tagResponse = await fetch('https://pwqgcrolbarwoilssltg.supabase.co/rest/v1/rfid_tags', {
                    method: 'POST',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3cWdjcm9sYmFyd29pbHNzbHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTgzNzA2NDgsImV4cCI6MjAzMzk0NjY0OH0.xIKlqvnIaZ6OvnZy8s8m_6A_azmo0POOq_ELGyO7GyE',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3cWdjcm9sYmFyd29pbHNzbHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTgzNzA2NDgsImV4cCI6MjAzMzk0NjY0OH0.xIKlqvnIaZ6OvnZy8s8m_6A_azmo0POOq_ELGyO7GyE',
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        tag_number: tagNumber,
                        assigned_to: userId
                    })
                });

                if (!tagResponse.ok) throw new Error('Failed to register tag.');

                alert('User and tag registered successfully!');
                document.getElementById('user-form').reset();
            } catch (error) {
                alert(error.message);
            }
        });
    </script>
</body>

</html>